!function(a){"use strict";function b(a){if(a)for(var b=0;b<a.iceServers.length;b++)a.iceServers[b].hasOwnProperty("urls")&&(a.iceServers[b].url=a.iceServers[b].urls,delete a.iceServers[b].urls)}function c(){var a,b,c=Array.prototype.slice.call(arguments),e=c.shift();if(e?"string"==typeof e?(d("create socket.io at url",e),b=c.shift(),a=io(e,b)):e.emit?(d("use existing socket.io"),b=c.shift(),a=e):(d("create socket.io"),b=e,a=io(b)):(d("create default socket.io"),a=io()),b)for(var g in b)r[g]=b[g];var h=r.pcConfig.iceServers;r.pcConfig.iceServers=[];for(var i=0,j=h.length;j>i;i++){var k=createIceServer(h[i].url,h[i].username,h[i].credential);k&&r.pcConfig.iceServers.push(k)}return d("create"),new f(a)}function d(){var a=Array.prototype.slice.call(arguments);a.unshift("[rtcs.io]"),console.log.apply(console,a)}function e(){var a=Array.prototype.slice.call(arguments);a.unshift("[rtcs.io]"),console.error.apply(console,a)}function f(a){function b(a,b,e){if(d(a,b),c.user&&(b.room||b.user)){var f=c.getRoomByMessage(b),g="receive"+a.charAt(0).toUpperCase()+a.substr(1,a.length-1);f[g].apply(f,e||[])}}this.io=a,this.localStream=s,this.peers={},this.peerId=0,this.media=null,this.rooms={},this.users={},this.user={},this.view=new i(this);var c=this;a.on("connect",function(){d("connect")}),a.on("disconnect",function(){d("disconnect")}),a.on("error",function(a){e(a),a.toString().match(/^Authentication error:/)&&(window.location=r.authPage)}),a.on("init",function(a){d("init",a),a.user&&(c.user=a.user,c.view.init(),a.rooms&&a.rooms.forEach(function(a){c.getRoom(a).join()}))}),a.on("webrtc",function(a){if(d("webrtc",a),c.media&&(a.peer||a.token&&a.user)&&(a.descr||a.ice||a.confirm||a.close)){var b=c.getPeer(a.peer,a.room,a.user,a.token);b&&(a.descr?b.setRemoteDescription(a.descr):a.ice?b.addIceCandidate(a.ice):a.confirm?b.confirm():a.close&&b.close())}}),a.on("open",function(a){b("open",a,[a])}),a.on("close",function(a){b("close",a)}),a.on("invite",function(a){b("invite",a)}),a.on("join",function(a){a.user&&b("join",a,[a.user])}),a.on("leave",function(a){a.user&&b("leave",a,[a.user])}),a.on("chat",function(a){b("chat",a,[a])}),a.on("peer",function(a){a.user&&a.token&&b("peer",a,[a.user,a.token])}),a.on("unpeer",function(a){a.user&&b("unpeer",a,[a.user])})}function g(a,b,c){if(!c){var d=b.toString().split("/");2===d.length&&(d[0]===a.user.id?c=d[1]:d[1]===a.user.id&&(c=d[0]))}this.joined=!1,this.socket=a,this.view=a.view,this.id=b,this.userId=c,this.users={},this.log=[],this["public"]={id:b},this.needOpen=!1,this.needHighlight=!1,this.lastTime=null}function h(a,b,c,d,e){this.socket=a,this.view=a.view,this.id=b,this.room=c,this.user=d,this.token=e,this.conn=null,this.isCaller=!1,this.confirmed=!1,this.remote=null,this.stream=null,this.localIce=[],this.remoteIce=[],this.video=document.createElement("video"),this.video.autoplay=!0,this.video.volume=1}function i(b){this.socket=b,this.localStream=b.localStream,this.main=a(".rtcsio"),this.box=a(".rtcsio-box"),this.contacts=a(".rtcsio-contacts"),this.peers=a(".rtcsio-peers"),this.logs=a(".rtcsio-logs"),this.rooms=a(".rtcsio-rooms"),this.videoBox=a(".rtcsio-video"),this.video=this.videoBox.find("video").get(0),this.selfVideoBox=a(".rtcsio-self"),this.selfVideo=this.selfVideoBox.find("video").get(0),this.messageForm=a(".rtcsio-message-form"),this.contactsForm=a(".rtcsio-contacts-form"),this.inputMessage=a(".rtcsio-input-message"),this.inputName=a(".rtcsio-input-name"),this.btnMenu=a(".rtcsio-btn-menu"),this.btnSend=a(".rtcsio-btn-send"),this.btnVideo=a(".rtcsio-btn-video"),this.btnAudio=a(".rtcsio-btn-audio"),this.btnMedia=a(".rtcsio-btn-media"),this.btnRoom=a(".rtcsio-btn-room"),this.btnUser=a(".rtcsio-btn-user"),this.btnContacts=a(".rtcsio-btn-contacts"),this.btnLog=a(".rtcsio-btn-log"),this.btnMembers=a(".rtcsio-btn-members"),this.tplRoom=a(".rtcsio-tpl-room"),this.tplUser=a(".rtcsio-tpl-user"),this.tplMessage=a(".rtcsio-tpl-message"),this.tplMember=a(".rtcsio-tpl-member"),this.tplPeer=a(".rtcsio-tpl-peer"),this.activeContact=null,this.activePeer=null,this.mediaContact=null;var c=this;this.video.autoplay=!0,this.video.volume=0,this.selfVideo.autoplay=!0,this.selfVideo.volume=0,this.selfVideoBox.click(function(){n(c.video,c.selfVideo),c.activePeer&&c.activePeer.viewPeer.slideDown().fadeIn(),c.selfVideoBox.slideUp().fadeOut(),c.activePeer=null}),this.messageForm.submit(function(){if(c.activeContact){var a=c.inputMessage.val().trim();a&&(c.activeContact.chat(a),c.inputMessage.val(""))}return c.inputMessage.focus(),!1}),this.btnMenu.click(function(){return c.box.toggleClass("rtcsio-box-min"),!1}),this.btnRoom.click(function(){var a=c.inputName.val().trim();return a&&(c.socket.getRoom(a).join(!0),c.inputName.val("")),c.btnLog.click(),c.inputMessage.focus(),!1}),this.btnUser.click(function(){var a=c.inputName.val().trim();return a&&(c.socket.getUser(a).join(!0),c.inputName.val("")),c.btnLog.click(),c.inputMessage.focus(),!1}),this.btnMedia.click(function(){return c.mediaToggle(),!1}),this.btnVideo.click(function(){return c.videoToggle(),!1}),this.btnAudio.click(function(){return c.audioToggle(),!1}),this.btnContacts.click(function(){c.box.removeClass("rtcsio-box-log").removeClass("rtcsio-box-members").addClass("rtcsio-box-contacts"),c.btnContacts.addClass("rtcsio-btn-contacts-active"),c.btnLog.removeClass("rtcsio-btn-log-active"),c.btnMembers.removeClass("rtcsio-btn-members-active")}),this.btnLog.click(function(){c.box.removeClass("rtcsio-box-contacts").removeClass("rtcsio-box-members").addClass("rtcsio-box-log"),c.btnContacts.removeClass("rtcsio-btn-contacts-active"),c.btnLog.addClass("rtcsio-btn-log-active"),c.btnMembers.removeClass("rtcsio-btn-members-active")}),this.btnMembers.click(function(){c.box.removeClass("rtcsio-box-contacts").removeClass("rtcsio-box-log").addClass("rtcsio-box-members"),c.btnContacts.removeClass("rtcsio-btn-contacts-active"),c.btnLog.removeClass("rtcsio-btn-log-active"),c.btnMembers.addClass("rtcsio-btn-members-active")})}function j(a){return String(a).replace(/[&<>"]/g,function(a){return t[a]})}var k=null,l=null,m=null,n=null,o=null,p=null;if(navigator.mozGetUserMedia)console.log("This appears to be Firefox"),o="firefox",p=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),k=function(a,c){return b(a),new mozRTCPeerConnection(a,c)},window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate,l=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=l,MediaStreamTrack.getSources=function(a){setTimeout(function(){var b=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];a(b)},0)},window.createIceServer=function(a,b,c){var d=null,e=a.split(":");if(0===e[0].indexOf("stun"))d={url:a};else if(0===e[0].indexOf("turn"))if(27>p){var f=a.split("?");(1===f.length||0===f[1].indexOf("transport=udp"))&&(d={url:f[0],credential:c,username:b})}else d={url:a,credential:c,username:b};return d},window.createIceServers=function(a,b,c){for(var d=[],e=0;e<a.length;e++){var f=window.createIceServer(a[e],b,c);null!==f&&d.push(f)}return d},m=function(a,b){console.log("Attaching media stream"),a.mozSrcObject=b},n=function(a,b){console.log("Reattaching media stream"),a.mozSrcObject=b.mozSrcObject};else if(navigator.webkitGetUserMedia){console.log("This appears to be Chrome"),o="chrome";var q=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);p=null!==q?parseInt(q[2],10):999,window.createIceServer=function(a,b,c){var d=null,e=a.split(":");return 0===e[0].indexOf("stun")?d={url:a}:0===e[0].indexOf("turn")&&(d={url:a,credential:c,username:b}),d},window.createIceServers=function(a,b,c){return{urls:a,credential:c,username:b}},k=function(a,b){return new webkitRTCPeerConnection(a,b)},l=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=l,m=function(a,b){"undefined"!=typeof a.srcObject?a.srcObject=b:"undefined"!=typeof a.mozSrcObject?a.mozSrcObject=b:"undefined"!=typeof a.src?a.src=URL.createObjectURL(b):console.log("Error attaching stream to element.")},n=function(a,b){a.src=b.src}}else console.log("Browser does not appear to be WebRTC-capable");var r={pcConfig:{iceServers:[]},pcConstraints:{optional:[{googImprovedWifiBwe:!0},{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}],mandatory:{}},offerConstraints:{optional:[{VoiceActivityDetection:!1}],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerConstraints:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},localConstraints:{audio:!0,video:{optional:[],mandatory:{}}},authPage:null};c.localStream=s,c.Socket=f,c.Room=g,c.Peer=h,c.View=i,window.rtcsio=c;var s={need:!1,stream:null,queue:!1,video:!0,audio:!0,videoEnabled:function(a){this.video=a,this.stream&&this.tracksEnabled(this.stream.getVideoTracks(),a)},audioEnabled:function(a){this.audio=a,this.stream&&this.tracksEnabled(this.stream.getAudioTracks(),a)},tracksEnabled:function(a,b){for(var c=0;c<a.length;c++)a[c].enabled=b},start:function(a){var b=this;b.need=!0,b.stream?a&&a(b.stream):b.queue?b.queue.push(a):(b.queue=[],l(r.localConstraints,function(c){b.stream=c,b.need||b.stop(),b.stream&&(b.videoEnabled(b.video),b.audioEnabled(b.audio),a&&a(b.stream),b.queue.forEach(function(a){a&&a(b.stream)})),b.queue=!1},function(a){d(a),b.queue=!1}))},stop:function(){this.need=!1,this.stream&&(this.stream.stop(),this.stream=null)}};f.prototype.getRoom=function(a,b){return a="object"==typeof a?a.id:a,this.rooms[a]||(this.rooms[a]=new g(this,a,b))},f.prototype.getUser=function(a){return a="object"==typeof a?a.id:a,this.getRoom(this.user.id>a?this.user.id+"/"+a:a+"/"+this.user.id,a)},f.prototype.getRoomByMessage=function(a){return a.room?this.getRoom(a.room):a.user?this.getUser(a.user):void 0},f.prototype.getPeer=function(a,b,c,d){return a?(this.peers[a].token=d,this.peers[a]):c&&d?(a=++this.peerId,this.peers[a]=new h(this,a,b,c,d)):void 0},f.prototype.start=function(a){this.stop(!0),this.media=a;var b=this;s.start(function(){b.view.start(a)})},f.prototype.stop=function(a){if(this.media){this.view.stop(this.media),this.media=null;for(var b in this.peers)this.peers[b].close()}a||s.stop()},g.prototype.emit=function(a,b){b||(b={}),this.userId?b.user=this.userId:b.room=this.id,this.socket.io.emit(a,b)},g.prototype.join=function(a){if(this.joined)a&&this.view.open(this);else{var b={};this.lastTime&&(b.time=this.lastTime),this.emit("join",b),this.needOpen=a}},g.prototype.leave=function(){this.joined&&(this.emit("leave"),this.joined=!1,this.view.remove(this),delete this.socket.rooms[this.id])},g.prototype.chat=function(a){this.emit("chat",{message:a});var b={time:+new Date,user:this.socket.user,message:a};this.log.push(b),this.view.chat(this,b)},g.prototype.peer=function(){this.emit("peer"),this.socket.start(this)},g.prototype.unpeer=function(){this.emit("unpeer"),this.socket.stop()},g.prototype.receiveOpen=function(a){if(!this.joined){this.joined=!0,a.room?(this["public"]=a.room,this["public"].id=this.id):a.user&&(this["public"]=a.user,this["public"].id=this.id),this.view.add(this);var b;if(a.users){for(b in a.users)this.receiveJoin(a.users[b]);for(b in this.users)a.users[b]||this.receiveLeave(b)}else for(b in this.users)this.receiveLeave(b);a.log&&a.log.forEach(function(a){this.receiveChat(a,!this.needHighlight)},this),this.needHighlight=!1,this.needOpen&&(this.view.open(this),this.needOpen=!1)}},g.prototype.receiveClose=function(){this.leave()},g.prototype.receiveInvite=function(){this.join()},g.prototype.receiveJoin=function(a){a.id&&!this.users[a.id]&&(this.users[a.id]=a,this.view.join(this,a))},g.prototype.receiveLeave=function(a){this.users[a]&&(this.view.leave(this,this.users[a]),delete this.users[a])},g.prototype.receiveChat=function(a,b){if(this.joined){if(!a.time||!a.user||!a.message)return;if("object"!=typeof a.user){if(!this.users[a.user])return;a.user=this.users[a.user]}this.log.push(a),this.view.chat(this,a,b),this.lastTime=a.time}else this.needHighlight=!0,this.join()},g.prototype.receivePeer=function(a,b){this.users[a]&&(this.view.media(this,this.users[a]),this===this.socket.media&&this.socket.getPeer(null,this.id,a,b).offer())},g.prototype.receiveUnpeer=function(a){this.users[a]&&this.view.unmedia(this,this.users[a])},h.prototype.emit=function(a){a.peer=this.id,this.token&&(a.token=this.token,this.token=null),this.socket.io.emit("webrtc",a)},h.prototype.createConnection=function(a){var b=this;s.start(function(c){d("PeerConnection"),b.conn=new k(r.pcConfig,r.pcConstraints),d("addStream"),b.conn.addStream(c),b.conn.onicecandidate=function(a){a&&a.candidate&&b.sendIceCandidate(a.candidate)},b.conn.onaddstream=function(a){b.stream=a.stream,m(b.video,b.stream),b.view.peer(b)},a()})},h.prototype.offer=function(){this.isCaller=!0;var a=this;a.createConnection(function(){a.conn.createOffer(function(b){d("setLocalDescription"),a.conn.setLocalDescription(b),a.emit({descr:b})},function(a){d(a)},r.offerConstraints)})},h.prototype.answer=function(){var a=this;a.createConnection(function(){a.setRemoteDescription(),a.conn.createAnswer(function(b){d("setLocalDescription"),a.conn.setLocalDescription(b),a.emit({descr:b})},function(a){d(a)},r.answerConstraints)})},h.prototype.setRemoteDescription=function(a){a&&(this.remote=a),this.conn?this.remote&&(d("setRemoteDescription"),this.conn.setRemoteDescription(new RTCSessionDescription(this.remote)),this.isCaller&&this.confirm()):this.answer()},h.prototype.confirm=function(){this.isCaller&&this.emit({confirm:!0}),this.confirmed=!0,this.sendIceCandidate(),this.addIceCandidate()},h.prototype.sendIceCandidate=function(a){if(a)this.confirmed?(d("sendIceCandidate"),this.emit({ice:a})):this.localIce.push(a);else if(this.confirmed)for(var b=0,c=this.localIce.length;c>b;b++)d("sendIceCandidate"),this.emit({ice:this.localIce[b]})},h.prototype.addIceCandidate=function(a){if(a)this.confirmed?(d("addIceCandidate"),this.conn.addIceCandidate(new RTCIceCandidate(a))):this.remoteIce.push(a);else if(this.confirmed)for(var b=0,c=this.remoteIce.length;c>b;b++)d("addIceCandidate"),this.conn.addIceCandidate(new RTCIceCandidate(this.remoteIce[b]))},h.prototype.close=function(){delete this.socket.peers[this.id],this.conn&&(this.conn.close(),this.conn=null,this.emit({close:!0})),this.view.unpeer(this)},i.prototype.name=function(a){var b=localStorage.getItem("rtcsio.name");b||(b=prompt("Enter your name"),localStorage.setItem("rtcsio.name",b)),a(b)},i.prototype.init=function(){this.main.show(),this.inputMessage.focus()},i.prototype.add=function(b,c){if(!b.viewContact){b.viewContact=a("<div>").hide().addClass("rtcsio-contact").html(this.tpl(b.userId?this.tplUser:this.tplRoom,b["public"])).appendTo(this.contacts).slideDown().fadeIn(),b.viewLog=a("<div>").hide().addClass("rtcsio-log").appendTo(this.logs),b.log.forEach(function(a){this.chat(b,a,c)},this),b.viewMembers={},b.viewRoom=a("<div>").hide().addClass("rtcsio-room").appendTo(this.rooms);for(var d in b.users)this.join(b,b.users[d]);var e=this;b.viewContact.click(function(){e.open(b)}),b.viewContact.find(".rtcsio-contact-close").click(function(){return b.leave(),!1}),e.activeContact||e.open(b)}},i.prototype.remove=function(a){if(a===this.activeContact){var b=a.viewContact.prev();b.length?b.click():a.viewContact.next().click()}a.viewContact&&a.viewContact.slideUp().fadeOut(function(){a.viewContact.remove(),delete a.viewContact}),a.viewLog&&(a.viewLog.remove(),delete a.viewLog),a.viewRoom&&(a.viewRoom.remove(),delete a.viewRoom,delete a.viewMembers)},i.prototype.open=function(a){this.add(a),this.close(),a.viewContact&&(a.viewContact.removeClass("rtcsio-contact-highlight"),a.viewContact.addClass("rtcsio-contact-active")),a.viewLog&&a.viewLog.show(),a.viewRoom&&a.viewRoom.show(),this.activeContact=a,this.btnLog.click()},i.prototype.close=function(){this.activeContact&&(this.activeContact.viewContact&&this.activeContact.viewContact.removeClass("rtcsio-contact-active"),this.activeContact.viewLog&&this.activeContact.viewLog.hide(),this.activeContact.viewRoom&&this.activeContact.viewRoom.hide(),this.activeContact=null)},i.prototype.join=function(b,c){b.viewRoom&&!b.viewMembers[c.id]&&(b.viewMembers[c.id]=a("<div>").hide().addClass("rtcsio-member").html(this.tpl(this.tplMember,c)).appendTo(b.viewRoom).slideDown().fadeIn().click(function(){b.socket.getUser(c.id).join(!0)}))},i.prototype.leave=function(a,b){a.viewMembers&&b.id&&a.viewMembers[b.id]&&a.viewMembers[b.id].slideUp().fadeOut(function(){a.viewMembers[b.id].remove(),delete a.viewMembers[b.id]})},i.prototype.chat=function(a,b,c){if(a.viewContact&&a.viewLog){this.activeContact===a||c||a.viewContact.addClass("rtcsio-contact-highlight");var d=a.viewLog.prop("scrollHeight")-a.viewLog.height()-a.viewLog.scrollTop()<50;a.viewLog.append(this.tpl(this.tplMessage,b.user).replace("{time}",this.time(b.time)).replace("{message}",this.message(b.message))),d&&a.viewLog.stop().animate({scrollTop:a.viewLog.prop("scrollHeight")-a.viewLog.height()},"fast")}},i.prototype.peer=function(b){var c=this;b.viewPeer=a("<div>").hide().addClass("rtcsio-peer").click(function(){n(c.video,b.video),c.activePeer?c.activePeer.viewPeer.slideDown().fadeIn():c.selfVideoBox.slideDown().fadeIn(),b.viewPeer.slideUp().fadeOut(),c.activePeer=b}).html(this.tpl(this.tplPeer,b.user)),b.viewPeer.find("video").replaceWith(b.video),b.viewPeer.appendTo(this.peers).slideDown().fadeIn(),this.activePeer||b.viewPeer.click()},i.prototype.unpeer=function(a){if(a.viewPeer&&(a.viewPeer.slideUp().fadeOut(function(){a.viewPeer.remove(),delete a.viewPeer}),a===this.activePeer)){this.activePeer=null;var b=!1;for(var c in this.socket.peers)if(this.socket.peers[c].confirmed&&this.socket.peers[c].viewPeer){this.socket.peers[c].viewPeer.click(),b=!0;break}b||this.selfVideoBox.click()}},i.prototype.media=function(a,b){a.viewMembers&&a.viewMembers[b.id]&&(a.viewMembers[b.id].viewHasMedia=!0,a.viewMembers[b.id].addClass("rtcsio-member-media")),a.viewContact&&a.viewContact.addClass("rtcsio-contact-media")},i.prototype.unmedia=function(a,b){if(a.viewMembers&&(a.viewMembers[b.id]&&(a.viewMembers[b.id].viewHasMedia=!1,a.viewMembers[b.id].removeClass("rtcsio-member-media")),a.viewContact)){var c=!1;for(var d in a.viewMembers)if(a.viewMembers[d].viewHasMedia){c=!0;break}c||a.viewContact.removeClass("rtcsio-contact-media")}},i.prototype.start=function(a){m(this.selfVideo,this.socket.localStream.stream),this.selfVideoBox.hide().click(),this.videoBox.fadeIn(),a.viewContact&&a.viewContact.addClass("rtcsio-contact-media-active"),this.mediaContact=a},i.prototype.stop=function(){this.selfVideoBox.slideUp().fadeOut(),this.videoBox.fadeOut(),this.mediaContact&&(this.mediaContact.viewContact&&this.mediaContact.viewContact.removeClass("rtcsio-contact-media-active"),this.mediaContact=null)},i.prototype.mediaToggle=function(){this.mediaContact?(this.mediaContact.unpeer(),this.btnMedia.removeClass("rtcsio-btn-active"),this.box.removeClass("rtcsio-box-min")):this.activeContact&&(this.activeContact.peer(),this.btnMedia.addClass("rtcsio-btn-active"),this.box.addClass("rtcsio-box-min"))},i.prototype.videoToggle=function(){var a=this.localStream.video;this.localStream.videoEnabled(!a),a?this.btnVideo.removeClass("rtcsio-btn-active"):this.btnVideo.addClass("rtcsio-btn-active")},i.prototype.audioToggle=function(){var a=this.localStream.audio;this.localStream.audioEnabled(!a),a?this.btnAudio.removeClass("rtcsio-btn-active"):this.btnAudio.addClass("rtcsio-btn-active")},i.prototype.tpl=function(a,b){var c=a.html();for(var d in b)c=c.replace("{"+d+"}",j(b[d]));return b.id&&!b.name&&(c=c.replace("{name}",j(b.id))),c},i.prototype.time=function(a){return new Date(a).toTimeString().substr(0,8)},i.prototype.message=function(a){return j(a)};var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}}(jQuery);